# SW要求仕様書

## 1. 目的
- 本書は「状態遷移設計支援ツール」のソフトウェア要求を明確化し、以降の詳細設計・実装・テストの基準とする。
- 開発環境は Electron + TypeScript を前提とし、デスクトップアプリとして提供する。

## 2. 対象読者
- プロダクトオーナー、UX デザイナー、開発者、テスター、運用担当。

## 3. システム概要
- 状態遷移表と状態遷移図を用いた設計を支援し、階層型状態遷移・擬似コード記述・シミュレーション・多形式エクスポート・LLM 支援を備えるオフライン指向のデスクトップアプリ。

## 4. 前提条件・制約
- 端末 OS: Windows / macOS / Linux（Electron サポート範囲）。
- ネットワークなしでも主要機能が動作すること（LLM 連携はオンラインを前提）。
- 保存形式はプロジェクト単位のローカルファイル（JSON/SQLite/IndexedDB）とし、外部 DB への依存なし。
- UI 言語: 日本語優先（多言語対応は将来課題）。

## 5. 用語
- **状態リスト**: 状態の集合。プロジェクト内で複数定義可能。各状態遷移表は1つの状態リストを選択して使用。
- **イベントリスト**: イベントの集合。プロジェクト内で複数定義可能。各状態遷移表は1つのイベントリストを選択して使用。
- **状態遷移表**: 行=イベント、列=状態、セル=遷移先／処理の2次元対応表。スプレッドシート形式で編集可能。
- **状態遷移図**: Node(状態)/Edge(遷移)で表現するグラフ。状態遷移表と双方向同期。
- **階層状態**: 親子関係をもつ状態。最大階層深さは5。親状態が折畳まれると子状態も非表示になる。
- **擬似コード**: 内蔵DSLで記述する手続き。順次/分岐/反復をサポート。セル内の「処理」として記述。
- **遷移先**: 状態遷移表のセルに記述される、イベント発生時の次の状態。空白の場合は状態変化なし。
- **処理**: 状態遷移表のセルに記述される擬似コード。イベント発生時に実行される。
- **アクション図**: 擬似コードをフローチャート風に可視化した図。順次/分岐/反復をノードとエッジで表現。
- **シミュレーション**: 初期状態・変数とイベント列を与えて状態遷移の実行をトレースする機能。
- **折れ線チャート**: シミュレーション結果の変数・状態遷移を時系列でプロットしたグラフ。連続的な変化を表現。
- **ステップチャート**: シミュレーション結果を階段状にプロットしたグラフ。離散的な状態変化を表現。
- **パネル**: 編集領域内に配置される個別のビューコンテナ。表ビューまたは図ビューを表示。複数パネルを並べて同時表示可能。
- **スナップショット**: プロジェクト全データの自動バックアップ。クラッシュ時の復旧に使用。
- **リアルタイム双方向同期**: 表ビューと図ビューで同一状態遷移を開いた場合、一方の編集が即座に他方に反映される機能。

## 6. アーキテクチャ方針・技術選定
- **フレームワーク**: Electron + Vite + React(TypeScript)  
  - 理由: 開発生産性、エコシステム、クロスプラットフォーム配布の容易さ。
- **状態管理**: Zustand + Immer  
  - 理由: シンプルで局所的なグローバル状態管理、Undo/Redo 実装容易。
- **UI コンポーネント**: MUI (Material UI) + 自前テーマ変数  
  - 理由: デスクトップライクな操作性とテーマカスタムの両立。Serendie Design のテーマ色を取り込む拡張点を設ける。
- **グリッド**: AG Grid Community（Handsontable CE と比較 PoC の結果で採用）  
  - 理由: 固定ヘッダ・仮想スクロール性能、Row Group/Tree Data による階層折畳、カスタムセルエディタ API が充実し無償版で要件を満たす。
- **ダイアグラム**: React Flow + elkjs（デフォルト）/ dagre（オプション）  
  - 理由: elkjs の階層レイアウト品質を優先しつつ、軽量な dagre を代替として残す。UI から切替可。Graphviz dot のレイアウト種別に準じたオプション名を提示。
- **コードエディタ**: Monaco Editor  
  - 理由: VS Code 相当の編集体験とシンタックスハイライト。
- **DSL/パーサ**: Chevrotain (または Nearley) で擬似コード文法を定義。アクション図生成とシミュレーションで共用する AST を生成。
- **データ保存**: IndexedDB(Dexie) + プロジェクトファイルの JSON エクスポート/インポート。  
- **ファイル出力**: exceljs（XLSX）, markdown-it/remark（Markdown）, Handlebars（テンプレート出力）。
- **検索/ハイライト**: Fuse.js（全文検索）+ カスタムハイライト層。
- **シミュレーションログ**: structured-clone 互換の JSON ログ、表示に React Table。
- **LLM 連携**: OpenAI API ラッパー（後日 API キー設定）。  
- **テスト**: Vitest + Playwright（E2E 部分）。

## 7. 機能要求（機能 ID 付与）
- FR-001: 状態遷移表をスプレッドシート感覚で編集（行=イベント、列=状態）。固定ヘッダ・仮想スクロール対応。
- FR-002: 表セルに「遷移先」「処理（擬似コード）」を記入。表示切替（処理のみ/遷移先のみ/両方）。
- FR-003: 行折畳/展開を行単位および全体一括で切替。
- FR-004: 文字列検索とフィルタ。ヒットセルのハイライト、検索結果ダイアログとセル連動移動。結果リスト選択で該当セルへスクロール＆フォーカス。
- FR-005: 拡大/縮小（Ctrl+ホイール、ショートカット）。倍率 25–400% を保持。
- FR-006: 状態遷移図の作成・編集（マウス/キーボード両対応）。Draw.io 風操作（ドラッグ配置、複数選択、コピー/削除、スナップ/整列）。
- FR-007: 複数レイアウトエンジン（dagre/elkjs 等）による自動配置。Graphviz dot に準じたレイアウト種別名を選択肢として提示。
- FR-008: 階層型状態遷移の表現と編集（親子ノード、折畳）。
- FR-009: 複数のイベントリストを作成・遷移表で選択。リスト切替時は既存セルデータとの整合性を確認し、不整合があれば警告ダイアログを表示。既存セルはクリアせず保持し、新リストに存在しないイベントは「未定義」として表示。
- FR-010: 複数の状態リストを作成・遷移表で選択。リスト切替時は既存セルデータとの整合性を確認し、不整合があれば警告ダイアログを表示。既存セルはクリアせず保持し、新リストに存在しない状態は「未定義」として表示。
- FR-011: 擬似コード編集（セル内ダブルクリックで編集ダイアログ起動、Monaco エディタでシンタックスハイライト、変数・キーワード補完、パースエラーのリアルタイム表示）。保存時(Ctrl+S)にセルへ反映。
- FR-012: 擬似コードからアクション図を生成・表示。
- FR-013: シミュレーション（初期状態・変数設定、イベント列設定、開始/一時停止/再開、ログ出力、完了レポート）。イベントごとに処理ステップ・変数更新・状態遷移ログを収集。可視化は折れ線/ステップチャートを切替可能（ADR doc/91_adr_poc_ui_behavior.md）。
- FR-014: 変数・定数の事前定義、順次/分岐/反復の組込みキーワードを用いた DSL 実行。`break`/`continue` をループ内で使用可能（ADR doc/92_adr_dsl_break_continue.md）。
- FR-015: 状態遷移表のエクスポート（Excel, Markdown）。
- FR-016: 状態遷移表からテンプレートに従った出力（任意書式、Handlebars）。
- FR-017: 状態遷移表から任意言語コード生成（LLM 支援、ユーザーが言語指定）。
- FR-018: 任意言語コードから状態遷移表へのリバース（LLM 支援）。
- FR-019: 複数状態遷移のエクスプローラ（サイドバー）での参照/折畳/展開/複製/削除。表示位置を左右切替、非表示可。
- FR-020: 編集領域に複数パネルを配置し、最小化/最大化/任意リサイズ可。パネルごとに任意の状態遷移を表示。
- FR-021: 同一状態遷移を複数パネルで開き、表と図をリアルタイム双方向同期で連動編集。一方での編集操作(セル編集、ノード移動、エッジ追加等)が即座に他方へ反映。
- FR-022: カラーテーマ切替（ライト/ダーク/Serendie）。
- FR-023: ビュー選択（表/図）を状態遷移ごとに指定。パネル単位で表示モードを保存。

## 8. UI/UX 要件
- グリッド: 固定ヘッダ、仮想スクロール、セル編集、ショートカット（コピー/ペースト/Undo/Redo）。セルダブルクリックで処理編集ダイアログを開く。
- 表示切替: セル表示を「処理のみ」「遷移先のみ」「両方」でトグル可能。
- ズーム: Ctrl+ホイール、+/- キー。ズーム倍率は 25–400% 範囲。ズーム状態はパネル単位で保持。
- 検索 UI: 検索バー + 結果ダイアログ。ヒットセルをハイライトし、ダイアログ選択で該当セルへスクロール＆フォーカス移動。フィルタ条件は再利用できる履歴を保持。
- 図編集: Draw.io 風操作（ドラッグ配置、キーボード移動/複製/削除、スナップライン、オートレイアウト後の手動微調整保持）。
- レイアウト選択: プルダウンで dagre/elkjs 等。Graphviz dot に準じたオプション名を表示。
- パネル: ドッキング/フローティング風のリサイズハンドル、最小化ボタン、最大化ボタン。複数パネルに同一状態遷移を表示して連動編集。
- エクスプローラ: サイドバーで状態遷移を参照/折畳/展開/複製/削除。左右配置切替と非表示切替。
- テーマ: ライト/ダーク/Serendie Design の 3 系列を選択。パネルとエクスプローラにも即時反映。
- アクセシビリティ: 主要操作にキーボードショートカット、フォーカスリング表示。
- ヘルプ: キーボード操作一覧は `doc/27_keyboard_shortcuts.md` を参照。

## 9. データモデル要件（概念レベル）
- Project { id, name, theme, stateLists[], eventLists[], transitions[], diagrams[], variables[], constants[], panels[], settings }
- StateList { id, name, states[] } （state は {id, name, parentId?, metadata}）
- EventList { id, name, events[] } （event は {id, name, metadata}）
- TransitionTable { id, stateListId, eventListId, cells[] }  
  - Cell { eventId, stateId, nextStateId?, actionCode?, notes?, collapsed? }
- Diagram { id, nodes[], edges[], layoutType }
- PseudoCode { id, text, ast?, actionDiagram? }
- SimulationScenario { id, initialState, initialVars, eventSequence[], logs[], report }
- Template { id, name, type(markdown/excel/custom), content }

- 文法: doc/02_report_pseudo_code.md で検証済みの最小文法に従う。順次 `;`、条件 `if/elseif/else/end`, 反復 `for/while/end`, 代入、関数呼び出し、イベント発火 `emit` をキーワードで提供。`break`/`continue` はループ内で使用可能とし、ループ外使用はパースエラー（ADR doc/92_adr_dsl_break_continue.md）。
- 変数・定数は事前宣言。型は疎指定（number/string/bool/any）。
- 構文木(AST)を生成し、実行エンジンとアクション図生成で共用。未閉じブロックや未知トークンは行番号付きでエラーを返却。
- エディタ機能: シンタックスハイライト、簡易補完、エラーマーカー。セルダブルクリックで専用ダイアログを開き、AST ベースのアクション図をプレビュー可能。

## 11. シミュレーション要件
- 初期設定 UI で状態・変数を指定。
- イベント列を順序付きで設定し、シミュレーション実行。実行中は開始/一時停止/再開を制御可能。
- 各イベント毎に: 処理ステップログ、変数更新ログ、状態遷移ログを保存。ログはタイムライン表示と CSV/JSON エクスポートを提供。
- ステップごとに擬似コード実行のトレース（stmtId, varsDelta, stateDelta, emits, type=break|continue?）を保持し、デバッグビューで確認可能。
- 完了後、変数遷移・状態遷移のレポートを生成（表形式・折れ線/ステップチャートを選択可）。

## 12. インポート/エクスポート・LLM 連携
- エクスポート: Excel (exceljs), Markdown, 任意テンプレート (Handlebars)。表と図を選択的に含められるオプションを提供。
- コード生成: LLM に状態遷移表を渡し、指定言語のコードを生成。生成結果は表示と同時にトレーサビリティ付きで保存。
- リバース: 任意言語コードを入力し、LLM で状態・イベント・遷移を抽出して表に変換。ユーザー確認ダイアログを挟む。
- オフライン時はエクスポート系のみ動作、LLM 機能は無効化表示。

### 12.1 LLM連携時のエラーハンドリング
**エラー種別と対応**:
1. **ネットワークエラー**(接続タイムアウト、DNS解決失敗)
   - リトライ: 3回まで自動リトライ(間隔: 1秒、2秒、4秒の指数バックオフ)
   - ユーザー通知: スナックバーで「ネットワークエラー。リトライ中... (1/3)」と表示
   - 最終失敗時: エラーダイアログで「ネットワーク接続を確認してください」と表示し、「再試行」「キャンセル」ボタンを提示

2. **API エラー**(401 認証失敗、429 レート制限、500 サーバーエラー)
   - 401: エラーダイアログで「API キーが無効です。設定画面で確認してください」と表示し、設定画面へのリンクを提示
   - 429: エラーダイアログで「API 使用制限に達しました。しばらく待ってから再試行してください」と表示し、待機時間(レスポンスヘッダの `Retry-After` を参照)を表示
   - 500/503: リトライ 3 回まで実行し、失敗時はエラーダイアログで「サーバーエラーが発生しました。時間をおいて再試行してください」と表示

3. **タイムアウト**(30秒以内に応答なし)
   - ユーザー通知: スナックバーで「処理に時間がかかっています...」と表示(15秒経過時)
   - タイムアウト時: エラーダイアログで「処理がタイムアウトしました。再試行してください」と表示し、「再試行」「キャンセル」ボタンを提示

4. **不正な応答**(JSON パースエラー、期待外のフォーマット)
   - ログ記録: エラー詳細をローカルログに記録(デバッグ用)
   - ユーザー通知: エラーダイアログで「LLM からの応答が不正です。再試行してください」と表示
   - フォールバック: ユーザーが手動で入力できるテキストエリアを表示

5. **コンテンツフィルタ**(LLM が安全性理由で応答拒否)
   - ユーザー通知: エラーダイアログで「入力内容がコンテンツポリシーに抵触しました。内容を確認してください」と表示
   - 再入力: 入力内容を編集可能な状態でダイアログを再表示

**共通方針**:
- すべてのエラーは操作ログに記録し、デバッグモードで詳細を確認可能にする
- ユーザー通知はエラーの原因と対処法を明示する(「エラーが発生しました」のみの表示は避ける)
- キャンセル可能: すべての LLM 通信は中断可能とし、「キャンセル」ボタンを提供

## 13. 非機能要件

### 13.1 性能要件
**測定条件**:
- プロジェクト規模: 状態数 100、イベント数 100、遷移表セル数 10,000(100x100)
- ターゲットマシン: CPU 4コア以上、メモリ 8GB 以上、SSD ストレージ
- 測定方法: P95レイテンシ(95パーセンタイル)を採用。各操作を10回実行し、上位5%を除外した最大値を測定値とする

**測定対象操作と目標値**:
- セルスクロール: 100ms 以内
- セル編集ダイアログ起動: 100ms 以内
- 検索実行(全文検索): 200ms 以内
- フィルタ適用: 100ms 以内
- ズーム操作(Ctrl+ホイール): 50ms 以内
- 行折畳/展開: 100ms 以内
- 図レイアウト自動配置(elkjs): 500ms 以内
- 図ノード移動(ドラッグ): 16ms 以内(60fps維持)
- Undo/Redo: 100ms 以内

### 13.2 起動時間要件
**測定条件**:
- プロジェクト規模: 状態数 100、イベント数 50、遷移表 5,000 セル、ダイアグラム 1 件(ノード 50、エッジ 80)
- ターゲットマシン: 上記13.1と同じ
- 測定方法: アプリ起動からメイン画面表示完了までの時間。Electron の `ready` イベントから最初の `paint` イベントまでを計測
- キャッシュ状態: ビルド後初回起動を除外し、2回目以降の起動時間を測定

**目標値**: 3 秒以内

### 13.3 信頼性要件
- Undo/Redo: 100 ステップ保持。メモリ使用量が 500MB を超える場合は古いステップから破棄。
- 自動保存: デフォルト間隔 30 秒（設定で 10秒〜5分の範囲で変更可）。
- データ整合性: 保存時に外部キー制約・階層深さ制約をアプリ層で検証し、違反時はエラーダイアログを表示。

### 13.4 可用性要件
- クラッシュ時の自動復旧: IndexedDB に自動保存されたスナップショットから復旧。スナップショット取得間隔は自動保存間隔と同じ。
- 復旧ダイアログ: 起動時にクラッシュを検出した場合、「復旧する」「破棄して新規作成」の選択肢を提示。
- スナップショット世代管理: 最新 3 世代を保持し、古い世代は自動削除。

### 13.5 ユーザビリティ要件
- ショートカット: 主要操作(検索、ズーム、Undo/Redo、保存)にキーボードショートカットを提供。ヘルプ画面(`doc/27_keyboard_shortcuts.md`)で一覧表示。
- ツールチップ: 全ボタン・アイコンにホバー時ツールチップを表示(表示遅延 500ms)。
- キーボード操作完結: マウスなしで表編集(セル移動、編集、保存)と図編集(ノード移動、削除)が可能。

### 13.6 セキュリティ要件
- ローカル保存: プロジェクトデータは IndexedDB にローカル保存。ネットワーク送信は LLM 連携時のみ。
- LLM 送信前確認: 確認ダイアログで送信内容を表示し、機密情報マスキングオプション(正規表現パターン指定)を提供。
- API キー保護: LLM API キーは OS のキーチェーン(Windows: Credential Manager、macOS: Keychain、Linux: Secret Service)に暗号化保存。

### 13.7 保守性要件
- モジュール分割:
  - `core`: モデル/DSL/シミュレータ(ビジネスロジック)
  - `ui`: 表/図/パネル(プレゼンテーション層)
  - `infra`: 保存/エクスポート/LLM(インフラストラクチャ層)
- 単体テストカバレッジ: core モジュールは 80% 以上、ui/infra は 60% 以上を目標。
- E2E テストカバレッジ: 主要操作フロー(表編集、図編集、検索、シミュレーション、エクスポート)を Playwright でカバー。

## 14. 運用・設定・ログ

### 14.1 設定管理
設定画面で以下の項目を管理:
- **テーマ**: ライト/ダーク/Serendie から選択
- **保存場所**: プロジェクトファイルのデフォルト保存ディレクトリ(変更可能)
- **オートセーブ間隔**: 10秒〜5分の範囲で設定(デフォルト: 30秒)
- **LLM API キー**: OpenAI API キーを暗号化保存(OSキーチェーン利用)
- **LLM タイムアウト**: 15秒〜60秒の範囲で設定(デフォルト: 30秒)
- **デバッグモード**: 操作ログの詳細記録を有効化(デフォルト: 無効)
- **スナップショット世代数**: 1〜10世代の範囲で設定(デフォルト: 3世代)

### 14.2 データバックアップ・復旧仕様

#### 14.2.1 自動スナップショット
**取得タイミング**:
- オートセーブ実行時に同時にスナップショットを取得(間隔は設定の「オートセーブ間隔」に従う)
- アプリ終了時(正常終了時のみ)
- シミュレーション実行直前(実験的な操作の前にバックアップ)

**保存場所**:
- IndexedDB 内の専用テーブル `snapshots(id, projectId, timestamp, data, description)`
- `data` には全プロジェクトデータを JSON シリアライズして保存

**世代管理**:
- プロジェクトごとに最新 N 世代を保持(N は設定で変更可能、デフォルト: 3)
- 古い世代は自動削除(FIFO)
- 各スナップショットにタイムスタンプと説明文を付与(例: "自動保存 2025-12-09 14:30:15")

#### 14.2.2 クラッシュ検出と自動復旧
**クラッシュ検出方法**:
- アプリ起動時に `isCleanShutdown` フラグをチェック
- 正常終了時は `isCleanShutdown = true` に設定
- 起動時に `false` であればクラッシュと判定

**復旧フロー**:
1. アプリ起動時にクラッシュを検出
2. 復旧ダイアログを表示:
   ```
   前回の実行が異常終了しました。
   プロジェクトを復旧しますか?

   [復旧可能なスナップショット一覧]
   - 自動保存 2025-12-09 14:30:15 (最新)
   - 自動保存 2025-12-09 14:29:45
   - 自動保存 2025-12-09 14:29:15

   [復旧する] [破棄して新規作成] [終了]
   ```
3. ユーザーがスナップショットを選択して「復旧する」をクリック
4. 選択したスナップショットから全データを復元
5. 復旧成功メッセージを表示: "プロジェクトを復旧しました (2025-12-09 14:30:15)"

**復旧失敗時の対応**:
- スナップショットの読み込みに失敗した場合、エラーダイアログを表示
- 別のスナップショットを選択可能にする
- すべてのスナップショットが破損している場合、「破棄して新規作成」を促す

#### 14.2.3 手動バックアップ・リストア
**手動バックアップ**:
- メニューバー: [ファイル] > [プロジェクトをエクスポート] > [バックアップとして保存]
- 保存形式: JSON ファイル(.stater.backup.json)
- 保存内容: プロジェクト全データ + スキーマバージョン + タイムスタンプ

**手動リストア**:
- メニューバー: [ファイル] > [プロジェクトをインポート] > [バックアップから復元]
- 復元前確認: 現在のプロジェクトを上書きする旨の警告ダイアログを表示
- スキーマバージョン不一致時: マイグレーション処理を実行(または互換性エラーを表示)

### 14.3 ログ管理
**ログ種別**:
1. **シミュレーションログ**: 各ステップの実行トレース(変数遷移、状態遷移、エラー)
   - 保存場所: IndexedDB `simulations` テーブル
   - CSV/JSON エクスポート可能

2. **エラーログ**: アプリ実行時のエラー(パースエラー、実行時エラー、LLMエラー)
   - 保存場所: ローカルファイル `%AppData%/stater/logs/error.log` (Windows) または `~/Library/Logs/stater/error.log` (macOS)
   - ローテーション: 10MB ごとに新ファイル作成、最新 5 ファイルを保持

3. **ユーザー操作ログ**(デバッグモード時のみ)
   - 記録内容: ボタンクリック、セル編集、検索、ズーム等の操作
   - 保存場所: 同上 `operation.log`
   - プライバシー保護: 設定でトグル可能(デフォルト: 無効)

**ログ閲覧**:
- メニューバー: [ヘルプ] > [ログを表示]
- ログビューアでエラーログと操作ログを閲覧可能(フィルタ、検索機能付き)

### 14.4 更新管理
- 自動アップデート通知: Electron autoUpdater を使用(将来対応項目)
- 更新チェック: アプリ起動時および手動チェック([ヘルプ] > [更新を確認])
- 更新前の自動バックアップ: 更新適用前に現在のプロジェクトを自動バックアップ

## 15. 受入れ基準（サンプル）
- 上記 FR-001〜FR-023 がデモで確認できること。
- 代表的なプロジェクトを Excel と Markdown に正しく出力できること。
- 擬似コードの if/for/while を含むサンプルがシミュレーションで正しく実行されること。
- dagre/elkjs いずれかでレイアウトが適用され、手動編集が保持されること。

## 16. 追加検討結果（1〜3）
- **(1) グリッド & レイアウトエンジン PoC**  
  - 観点: スクロール性能（1 万セル）、固定ヘッダ、階層折畳、カスタムセル編集 API、ライセンス、周辺エコシステム。  
  - 結果: AG Grid Community が要件を無償で充足し、性能余裕あり。Handsontable CE は階層折畳とカスタム編集で追加実装コスト増。  
  - 図レイアウト: elkjs を標準（階層・重なり解消が安定）、dagre を軽量代替として残す。

- **(2) 擬似コード DSL 最小文法 & AST 方針**  
  - 文法（EBNF 抜粋）:  
    - `program ::= stmt*`  
    - `stmt ::= assign | ifStmt | whileStmt | forStmt | call | emit | block`  
    - `assign ::= IDENT '=' expr`  
    - `ifStmt ::= 'if' expr block ('elseif' expr block)* ('else' block)? 'end'`  
    - `whileStmt ::= 'while' expr block 'end'`  
    - `forStmt ::= 'for' IDENT 'in' range block 'end'`  
    - `emit ::= 'emit' IDENT '(' args? ')'`  
    - `block ::= NEWLINE+ stmt* 'end'?`  
  - AST ノード例: Program, Block, Assign(id, expr), If(test, cons[], alt?), While(test, body), For(iter, range, body), Call(callee, args), Emit(eventId, args), Literal/Identifier/Binary。  
  - 実行エンジン: AST を直接解釈、ステップ毎に変数・状態・ログをフック。アクション図生成は AST を走査し分岐/反復をノード化。

- **(3) 永続化スキーマ（IndexedDB/Dexie）**  
  - DB バージョン 1 テーブル案:  
    - `projects(id, name, theme, createdAt, updatedAt)`  
    - `stateLists(id, projectId, name)` / `states(id, stateListId, name, parentId, meta)`  
    - `eventLists(id, projectId, name)` / `events(id, eventListId, name, meta)`  
    - `transitionTables(id, projectId, stateListId, eventListId, name)`  
    - `transitionCells(id, tableId, stateId, eventId, nextStateId, actionCode, notes, collapsed)`  
    - `diagrams(id, projectId, layoutType)` / `diagramNodes(id, diagramId, stateId, x, y, width, height)` / `diagramEdges(id, diagramId, sourceId, targetId, label)`  
    - `variables(id, projectId, name, type, initValue)` / `constants(id, projectId, name, value)`  
    - `templates(id, projectId, name, type, content)`  
    - `simulations(id, projectId, scenarioJson, logsJson, reportJson)`  
  - 保存単位: プロジェクトを JSON でエクスポート/インポートし、DB はキャッシュ兼編集用。  
  - マイグレーション: Dexie の `version(n).stores()` で段階追加、旧バージョンは JSON エクスポート→インポートでアップグレードするパスを用意。

## 17. 今後の課題
- 多言語 UI、チーム共有（クラウド同期）、リアルタイム協調編集。
- プラグイン機構（外部テンプレート/変換器の追加）。
- 形式検証ツールとの連携（例: model checking）。
