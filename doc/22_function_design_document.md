# 機能設計ドキュメント

## 1. 対象
- 状態遷移設計支援ツールの機能レベル設計。SRS(doc/11_software_requirement_specification.md) の更新内容（2025-12-09版）を前提に記述する。

## 2. グリッド（状態遷移表）
- **ライブラリ**: AG Grid Community を使用し、行=イベント、列=状態の固定ヘッダと仮想スクロールを有効化する。
- **セル表示モード**: 「処理のみ」「遷移先のみ」「両方」をトグル。表示状態はパネル単位で保持。ツールバーにトグルボタンを配置。
- **セル編集**:
  - ダブルクリックで擬似コード編集ダイアログを開く。ダイアログサイズ: 800x600px(リサイズ可能)。
  - エディタは Monaco Editor、AST 構築は Chevrotain ベースの DSL パーサを利用。
  - リアルタイムパースエラー表示: エディタ内に赤波線とエラーマーカーを表示。
  - 変数・キーワード補完: Ctrl+Space で変数名・DSLキーワード(if/while/for/break/continue/emit等)を補完候補表示。
  - 保存: Ctrl+S で保存 → セルへ反映 → リアルタイム双方向同期により図ビューも更新。
- **検索/フィルタ**:
  - Fuse.js による全文検索(あいまい検索対応)。検索バーはCtrl+Fで起動。
  - 結果ダイアログ: 検索ヒット一覧をサイドパネルまたはモーダルで表示。各項目に(行番号, 列番号, セル内容プレビュー)を含む。
  - ハイライト: ヒットセルを黄色背景でハイライト。フォーカスセルは青枠で強調。
  - キーボード操作: ↑↓で結果リスト内移動、Enter で該当セルへジャンプ、Esc でダイアログを閉じる。
- **ズーム**:
  - Ctrl+ホイールと +/- キーで 25–400% をサポート。Ctrl+0 でリセット。
  - ズーム倍率はパネル状態に保存し、再表示時に復元。
  - ズーム時もセルサイズを動的調整し、文字が読みやすい状態を維持。
- **行折畳**:
  - 行単位トグル: 各行の左端に折畳ボタンを配置(階層状態の親行のみ表示)。
  - 全体一括トグル: ツールバーに「全て展開」「全て折畳」ボタンを配置。
  - 階層状態対応: 親子関係をツリー構造で表現し、親行折畳時は子行を非表示。
- **イベント/状態リスト切替**:
  - ドロップダウンメニューでリスト選択。切替時は既存セルデータの整合性をチェック。
  - 不整合検出時: 警告ダイアログで「リストを切り替えると、既存セルの一部が未定義になります。続行しますか?」と確認。
  - 未定義イベント/状態: セルに「[未定義: E99]」のように表示し、背景色を薄赤で警告。

## 3. 状態遷移図
- **ライブラリ**: React Flow を使用。ズーム・パン、ノード/エッジ選択、ドラッグアンドドロップをサポート。
- **レイアウトエンジン**:
  - 標準: elkjs(階層レイアウト品質が高い)
  - オプション: dagre(軽量、処理速度優先)
  - UI: プルダウンメニューで切替。Graphviz dot に準じたレイアウト名(dot/neato/fdp等)を選択肢として表示。
  - レイアウト切替時: 既存ノードの手動調整座標を一時保存し、「元に戻す」で復元可能に。
- **編集操作(Draw.io風)**:
  - ノード配置: ツールバーから状態ノードを選択 → キャンバス上でクリックまたはドラッグで配置。
  - エッジ接続: ノード端点から別ノードへドラッグ → エッジ生成、イベント選択ダイアログを表示。
  - 複数選択: Shift+クリックまたはCtrl+ドラッグで矩形選択。
  - コピー/貼付: Ctrl+C/Ctrl+V で選択ノード/エッジを複製。
  - 削除: Delete キーまたは右クリックメニューから削除。
  - 移動: 矢印キーで1px移動、Shift+矢印で10px移動(スナップなし)。
  - スナップ: デフォルトでグリッドスナップ有効(16pxグリッド)、Alt押下中は無効化。
  - 右クリックメニュー: プロパティ編集、複製、削除、レイアウト再適用。
- **リアルタイム双方向同期**: 図ビューでノード/エッジを編集すると、表ビューの対応セルが即座に更新。
- **階層状態**:
  - ノードの親子構造で表現。子ノードは親ノード内に配置(ネスト表示)。
  - 親ノード折畳: 親ノードをダブルクリックで折畳/展開トグル。折畳時は子ノードを非表示。
  - 最大階層深さ: 5階層まで対応。6階層目以降は警告表示。

## 4. パネル／エクスプローラ
- 複数パネルを編集エリアに配置し、最小化/最大化/任意リサイズをサポート。パネルごとに表/図ビューを切替、同一状態遷移を複数パネルで開いて同期編集する。
- サイドバー型エクスプローラで状態遷移を参照・折畳・展開・複製・削除。左右配置切替と非表示を可能にする。

## 5. テーマ
- ライト/ダーク/Serendie Design の 3 系列を提供。MUI テーマに Serendie のカラーセットを取り込むフックを設計し、パネルとエクスプローラへ即時反映する。

## 6. 擬似コード DSL
- 文法は doc/02_report_pseudo_code.md の最小文法を採用。`break`/`continue` をループ内でサポートし、ループ外使用はパースエラー（ADR doc/92_adr_dsl_break_continue.md）。
- AST をシミュレーションとアクション図生成で共用。未閉じブロックや未知トークンは行番号付きでエラー返却。
- 編集ダイアログで AST ベースのアクション図プレビューを表示。
- ステップログに `type=break|continue` を付与し、ログビューでハイライト可能とする。

## 7. シミュレーション
- 初期状態・変数・イベント列を設定して実行。イベントごとに処理ステップログ（stmtId, varsDelta, stateDelta, emits, type）を保持し、タイムライン UI で表示。
- ログは CSV/JSON エクスポートを提供し、完了後に変数遷移・状態遷移レポートを生成（表/折れ線/ステップチャート切替）。（ADR doc/91_adr_poc_ui_behavior.md）

## 8. エクスポート/LLM 連携
- Excel/Markdown/Handlebars で表と図を選択的に出力。LLM によるコード生成・リバースはトレーサビリティ付きで保存し、オフライン時はエクスポートのみ動作する。

## 9. 非機能補足
- 1 万セル規模で 100ms 以内の操作応答を目標。検索・折畳・ズーム操作も同等性能を要求。
- キーボードのみで表/図の基本編集を完結可能とする。
- キーボード操作の詳細は `doc/27_keyboard_shortcuts.md` を参照。
