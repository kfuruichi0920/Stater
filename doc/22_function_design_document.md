# 機能設計ドキュメント

## 1. 対象
- 状態遷移設計支援ツールの機能レベル設計。SRS(doc/11_software_requirement_specification.md) の更新内容（2025-12-09版）を前提に記述する。

## 2. グリッド（状態遷移表）
- AG Grid Community を使用し、行=イベント、列=状態の固定ヘッダと仮想スクロールを有効化する。
- セル表示モード: 「処理のみ」「遷移先のみ」「両方」をトグル。表示状態はテーブル単位で保持。
- セル編集: ダブルクリックで擬似コード編集ダイアログを開く。エディタは Monaco、AST 構築は Chevrotain ベースの DSL パーサを利用。
- 検索/フィルタ: Fuse.js による全文検索結果をハイライト。結果ダイアログ選択で対象セルへスクロール＆フォーカス。
- ズーム: Ctrl+ホイールと +/- キーで 25–400% をサポート。ズーム倍率はパネル状態に保存。
- 行折畳: 行単位/全体一括トグル。階層状態（親子行）の折畳に対応。

## 3. 状態遷移図
- React Flow を用い、elkjs を標準レイアウト、dagre をオプションとして切替可能にする。Graphviz dot のレイアウト名を UI 選択肢に採用。
- 編集操作: Draw.io 風（ドラッグ配置、キーボード移動/複製/削除、スナップライン）。オートレイアウト適用後も手動微調整を保持。
- 階層状態はノードの親子構造で表現し、折畳表示を提供。

## 4. パネル／エクスプローラ
- 複数パネルを編集エリアに配置し、最小化/最大化/任意リサイズをサポート。パネルごとに表/図ビューを切替、同一状態遷移を複数パネルで開いて同期編集する。
- サイドバー型エクスプローラで状態遷移を参照・折畳・展開・複製・削除。左右配置切替と非表示を可能にする。

## 5. テーマ
- ライト/ダーク/Serendie Design の 3 系列を提供。MUI テーマに Serendie のカラーセットを取り込むフックを設計し、パネルとエクスプローラへ即時反映する。

## 6. 擬似コード DSL
- 文法は doc/02_report_pseudo_code.md の最小文法を採用。`break`/`continue` をループ内でサポートし、ループ外使用はパースエラー（ADR doc/92_adr_dsl_break_continue.md）。
- AST をシミュレーションとアクション図生成で共用。未閉じブロックや未知トークンは行番号付きでエラー返却。
- 編集ダイアログで AST ベースのアクション図プレビューを表示。
- ステップログに `type=break|continue` を付与し、ログビューでハイライト可能とする。

## 7. シミュレーション
- 初期状態・変数・イベント列を設定して実行。イベントごとに処理ステップログ（stmtId, varsDelta, stateDelta, emits, type）を保持し、タイムライン UI で表示。
- ログは CSV/JSON エクスポートを提供し、完了後に変数遷移・状態遷移レポートを生成（表/折れ線/ステップチャート切替）。（ADR doc/91_adr_poc_ui_behavior.md）

## 8. エクスポート/LLM 連携
- Excel/Markdown/Handlebars で表と図を選択的に出力。LLM によるコード生成・リバースはトレーサビリティ付きで保存し、オフライン時はエクスポートのみ動作する。

## 9. 非機能補足
- 1 万セル規模で 100ms 以内の操作応答を目標。検索・折畳・ズーム操作も同等性能を要求。
- キーボードのみで表/図の基本編集を完結可能とする。
- キーボード操作の詳細は `doc/27_keyboard_shortcuts.md` を参照。
