# UX設計ドキュメント

## 1. 目的
- 状態遷移設計支援ツールの主要画面・操作・ナビゲーションを定義し、実装とテストの参照基準とする。
- 前提: SRS(doc/11_software_requirement_specification.md) と機能設計(doc/22_function_design_document.md) の 2025-12-09 版。

## 2. ペルソナと利用コンテキスト
- **システムエンジニア**: 既存装置の状態遷移を再設計。短時間で表と図を往復し整合性確認。オフライン作業多め。
- **UX/QA 担当**: 振る舞い仕様をレビューし、シミュレーションログを確認。検索/ハイライトとレポート出力を重視。
- **開発者**: コード生成・リバースを併用。LLM 連携はオンライン時のみ使用。

## 3. 情報アーキテクチャ
- **左/右サイドバー**: 状態遷移エクスプローラ（プロジェクト内の遷移セット一覧）。折畳/展開/複製/削除、左右配置と非表示トグル。
- **メインキャンバス**: 複数パネルをタブレスで並置。各パネルは「表ビュー」「図ビュー」を切替。パネルごとにズーム・表示モードを保持。
- **ユーティリティバー**: 検索、ズーム、レイアウト選択、テーマ切替、シミュレーション開始/停止をまとめた上部バー。
- **ドロワー/モーダル**: 擬似コード編集ダイアログ、検索結果ダイアログ、シミュレーション設定ダイアログ、エクスポート設定ダイアログ。

## 4. 主要画面・レイアウト
- **ホーム（プロジェクト選択）**: 最近プロジェクトカード、テンプレート新規、インポート。テーマ選択はここにも配置。
- **編集画面（標準）**: 左右にサイドバー可変、中央にパネルグリッド。上部にユーティリティバー。フッターに状態表示（ズーム率、選択セル、選択ノード、Undo/Redo ステータス）。
- **シミュレーション画面**: 編集画面上でオーバーレイ。左にシナリオ設定（初期状態・変数・イベント列）、右にログ/タイムライン/レポートタブ。実行/一時停止/再開ボタンを上部に固定。
- **エクスポート/LLM 画面**: モーダル。表/図の選択、書式テンプレート選択、コード生成対象言語、リバース入力テキストエリアを含む。

## 5. 主要操作フロー（詳細）

### 5.1 表を編集
1. イベント・状態リスト選択(ドロップダウン) → リスト切替時は既存セルデータの整合性を確認し、不整合があれば警告ダイアログを表示
2. セルダブルクリックで処理編集ダイアログ起動 → Monaco エディタで擬似コード入力 → シンタックスハイライトとエラーマーカーをリアルタイム表示
3. 保存ボタンクリックまたは Ctrl+S で保存 → セルに反映(**リアルタイム双方向同期**: 図ビューを開いている場合は即座に図側も更新)
4. 表示モードをツールバーで切替（処理のみ/遷移先のみ/両方） → 切替はパネル単位で保持

### 5.2 図を編集
1. 図ビューでノードをドラッグ配置、エッジを接続(Draw.io風操作、後述5.6参照)
2. レイアウト選択(dagre/elkjs)をプルダウンから適用 → 自動配置実行
3. 手動で位置微調整(矢印キー1px移動、Shift+矢印10px移動) → 調整後の座標を保存
4. **リアルタイム双方向同期**: 表ビューを開いている場合、ノード/エッジの編集が即座に表側のセルに反映

### 5.3 検索/フィルタ
1. 検索バー(Ctrl+F)に文字列入力 → Fuse.js で全文検索実行
2. 結果ダイアログ(モーダルまたはサイドパネル)にヒット一覧を表示 → 各項目に(行番号, 列番号, セル内容プレビュー)を含む
3. **キーボード操作**: ↑↓キーで結果リスト内を移動 → 選択項目に応じて表または図上の該当セル/ノードへ自動スクロール＆フォーカス移動(背景色ハイライト)
4. **マウス操作**: 結果リスト項目をクリック → 同様にスクロール＆フォーカス
5. Enter キーまたはダブルクリックで該当セルの編集ダイアログを開く
6. Esc キーで検索ダイアログを閉じる
7. フィルタ履歴をドロップダウンで保持し、再適用可能

### 5.4 シミュレーション実行フロー
1. **初期設定**: シミュレーション設定ダイアログで初期状態・変数値・イベント列を入力
2. **実行開始**: 「実行」ボタンクリック → 状態: Idle → Running に遷移 → タイムラインで各ステップの進行を表示
3. **一時停止**: 「一時停止」ボタンクリック → 状態: Running → Paused に遷移 → 現在ステップでログを保持し、変数値・状態をサイドパネルに表示
4. **再開**: 「再開」ボタンクリック → 状態: Paused → Running に遷移 → 一時停止地点から継続実行
5. **停止**: 「停止」ボタンクリック → 状態: Running/Paused → Stopped に遷移 → ログをクリアし、初期状態に戻る確認ダイアログを表示
6. **完了**: 全イベント処理完了 → 状態: Running → Completed に遷移 → レポート生成ダイアログを自動表示
7. **エラー発生**: 擬似コード実行時エラー → 状態: Running → Error に遷移 → エラーステップをタイムラインに赤色マークし、詳細をサイドパネルに表示、再開/停止の選択肢を提示

### 5.5 シミュレーション状態遷移図
```
[Idle] --[実行ボタン]--> [Running] --[一時停止ボタン]--> [Paused]
                           |                                 |
                           |                                 +--[再開ボタン]--> [Running]
                           |                                 |
                           +--[停止ボタン]---------------+  +--[停止ボタン]---+
                           |                              |                      |
                           +--[全イベント完了]--> [Completed]                  |
                           |                              |                      |
                           +--[エラー発生]--> [Error] ---+                     |
                                                           |                      |
                                                           +----------------------+--> [Stopped] --> [Idle]
```

### 5.6 Draw.io風操作の詳細
- **ノード配置**: ツールバーから状態ノードを選択 → キャンバス上でクリックまたはドラッグで配置
- **エッジ接続**: ノード端点から別ノードへドラッグ → エッジ生成、イベント選択ダイアログを表示
- **複数選択**: Shift+クリックまたはCtrl+ドラッグで矩形選択
- **コピー/貼付**: Ctrl+C/Ctrl+V で選択ノード/エッジを複製
- **削除**: Delete キーまたは右クリックメニューから削除
- **移動**: 矢印キーで1px移動、Shift+矢印で10px移動(スナップなし)
- **スナップ**: デフォルトでグリッドスナップ有効、Alt押下中は無効化
- **右クリックメニュー**: プロパティ編集、複製、削除、レイアウト再適用
- **ズーム**: Ctrl+ホイール、+/-キー、ピンチジェスチャー(タッチデバイス)

### 5.7 シミュレーション可視化
- レポートで折れ線/ステップチャートを切替可能（ADR doc/91_adr_poc_ui_behavior.md）
- 系列選択UI(チェックボックス)で状態・任意変数を選択 → チャートに重畳表示
- ホバーでツールチップにステップ番号・値を表示

### 5.8 エクスポート/LLM
- モーダルで形式・テンプレート・対象ビューを選択 → 実行 → 保存先を確認
- オンライン時のみ LLM 生成/リバースを有効化(オフライン時はボタンをグレーアウト)
- LLM 実行時は確認ダイアログでマスキングオプションを提示

## 6. キー UI コンポーネント仕様
- **AG Grid 設定**: 固定ヘッダ、仮想スクロール、階層折畳、セルエディタはダブルクリックで擬似コードダイアログ。ショートカット: Enter 編集、Ctrl+C/V コピー/貼付、Ctrl+Z/Y Undo/Redo。
- **React Flow 図キャンバス**: ズーム・パン（ホイール+ドラッグ）、ノード/エッジ選択、複数選択、Delete で削除、方向キーで 1px/Shift+方向で 10px 移動。スナップライン表示。
- **ズームコントロール**: ユーティリティバーの + / - / リセット、Ctrl+ホイール、ショートカット `Ctrl+Plus`, `Ctrl+Minus`, `Ctrl+0`。
- **テーマトグル**: ライト/ダーク/Serendie。即時反映し、パネル・サイドバーに適用。
- **検索ダイアログ**: ハイライト色をテーマに連動。結果リストで上下キー/マウス選択により表または図上の対象へフォーカス移動。
- **パネル管理**: 見出しバーに最小化/最大化/閉じる。ドラッグでリサイズ、格子状スナップ。ビュー種別（表/図）とズーム率を記憶。
- **ショートカットヘルプ**: 全体のキーボード操作一覧は `doc/27_keyboard_shortcuts.md` を参照。
- **パネルドッキング**: 簡易スナップグリッドによるドッキングを提供し、配置をローカル保存（ADR doc/91_adr_poc_ui_behavior.md）。

## 7. アクセシビリティと操作性
- フォーカスリングを全入力・セル・ノードに表示。Tab/Shift+Tab で主要フォーカス順を定義。
- キーボードのみで表編集（Enter で編集、F2 で再編集、Ctrl+F で検索）、図操作（矢印移動、Delete 削除、Ctrl+D 複製）を完結可能にする。
- カラーテーマはコントラスト比を WCAG AA 目標で調整（特にハイライトとエラーメッセージ）。
- Serendie テーマではアクセント/ハイライト色を明度補正し、コントラストを確保（ADR doc/91_adr_poc_ui_behavior.md）。

## 8. エラー表示とフィードバック
- 擬似コードパースエラー: 行番号付きトースト＋エディタ内マーカー。
- 保存/エクスポート/LLM 実行: 成功時スナックバー、失敗時は原因とリトライ提示。
- シミュレーション中断: エラー発生ステップをタイムラインにマークし詳細をサイドパネルに表示。

## 9. ローカライズ
- UI ラベルは日本語をデフォルト。英語化は将来拡張としてキー分離（i18n JSON）を前提に設計。

## 10. 未決事項 / TODO
- ~~シミュレーションログの可視化チャート種類（折れ線/ステップチャート）の最終選定。~~ → 解決済み(ADR 91: 両方実装し切替可能)
- ~~複数パネルをドラッグでドッキングする UI 挙動（スナップ領域の有無）を PoC で確定。~~ → 解決済み(ADR 91: スナップグリッド採用)
- Serendie テーマのアクセント色とハイライト色のコントラスト微調整(PoC中、ADR 91)。
